<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Aggregated count models in one dimension • inlabruCourseMay2025</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Aggregated count models in one dimension">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">inlabruCourseMay2025</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-installation" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Installation</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-installation">
<li><a class="dropdown-item" href="../articles/install.html">Software installation</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-notes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Notes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-notes">
<li><a class="external-link dropdown-item" href="http://www.maths.ed.ac.uk/~flindgre/inlabruCourseMay2025/inlabruCourseMay2025.pdf">Handwritten notes (pdf) (updated during breaks)</a></li>
    <li><a class="dropdown-item" href="../articles/lecture_notes.html">Random field and latent models</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials-day-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials Day 1</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials-day-">
<li><h6 class="dropdown-header" data-toc-skip>Random fields</h6></li>
    <li><a class="dropdown-item" href="../articles/random_fields_1d.html">1D models</a></li>
    <li><a class="dropdown-item" href="../articles/random_fields_2d.html">2D models</a></li>
    <li><a class="dropdown-item" href="../articles/aggregated_counts_1d.html">Aggregated count models</a></li>
    <li><a class="dropdown-item" href="../articles/nonseparable_spacetime.html">Non-separable covariance</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials-day-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials Day 2</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials-day-">
<li><a class="external-link dropdown-item" href="https://inlabru-org.github.io/inlabru/articles/2d_lgcp.html">Poisson Point processes</a></li>
    <li><a class="external-link dropdown-item" href="https://inlabru-org.github.io/inlabru/articles/2d_lgcp_distancesampling.html">Distance sampling transect surveys</a></li>
    <li><a class="dropdown-item" href="../articles/lgcp_2d_covars.html">Spatial covariates</a></li>
    <li><a class="dropdown-item" href="../articles/lgcp_2d_spatiotemporal.html">Spatio-temporal point processes</a></li>
    <li><a class="external-link dropdown-item" href="https://inlabru-org.github.io/inlabru/articles/zip_zap_models.html">Multi-likelihood models; zero-inflated models</a></li>
    <li><a class="external-link dropdown-item" href="https://inlabru-org.github.io/inlabru/articles/svc.html">Spatially varying coefficients</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/inlabru-org/inlabruCourseMay2025/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Aggregated count models in one dimension</h1>
                        <h4 data-toc-skip class="author">Finn
Lindgren</h4>
            
            <h4 data-toc-skip class="date">Generated on 2025-05-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/inlabru-org/inlabruCourseMay2025/blob/main/vignettes/aggregated_counts_1d.Rmd" class="external-link"><code>vignettes/aggregated_counts_1d.Rmd</code></a></small>
      <div class="d-none name"><code>aggregated_counts_1d.Rmd</code></div>
    </div>

    
    
<p>This tutorial modifies the <a href="random_fields_1d.html">1D random
fields</a> tutorial to properly handle aggregated counts.</p>
<div class="section level2">
<h2 id="setting-things-up">Setting things up<a class="anchor" aria-label="anchor" href="#setting-things-up"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.inlabru.org" class="external-link">inlabru</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inlabru-org.github.io/fmesher/" class="external-link">fmesher</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span></code></pre></div>
<p>Make a shortcut to a nicer colour scale:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colsc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">11</span>, <span class="st">"RdYlBu"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">...</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="get-the-data">Get the data<a class="anchor" aria-label="anchor" href="#get-the-data"></a>
</h2>
<p>Load the data and rename the countdata object to <code>cd</code>
(just because ‘<code>cd</code>’ is less to type than
‘<code>countdata2</code>’.):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Poisson2_1D</span><span class="op">)</span></span>
<span><span class="va">cd</span> <span class="op">&lt;-</span> <span class="va">countdata2</span></span></code></pre></div>
<p>Take a look at the count data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd</span></span>
<span><span class="co">#&gt;            x count exposure</span></span>
<span><span class="co">#&gt; 1   2.319888     9 4.639776</span></span>
<span><span class="co">#&gt; 2   6.959664    13 4.639776</span></span>
<span><span class="co">#&gt; 3  11.599439    11 4.639776</span></span>
<span><span class="co">#&gt; 4  16.239215    22 4.639776</span></span>
<span><span class="co">#&gt; 5  20.878991    20 4.639776</span></span>
<span><span class="co">#&gt; 6  25.518766    19 4.639776</span></span>
<span><span class="co">#&gt; 7  30.158542    16 4.639776</span></span>
<span><span class="co">#&gt; 8  34.798318     8 4.639776</span></span>
<span><span class="co">#&gt; 9  39.438093     4 4.639776</span></span>
<span><span class="co">#&gt; 10 44.077869     4 4.639776</span></span>
<span><span class="co">#&gt; 11 48.717645     4 4.639776</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cd</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cd</span><span class="op">$</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="aggregated_counts_1d_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p><em>Tip</em>:
<code>RStudio &gt; Help &gt; Cheatsheets &gt; Data visualisation with ggplot2</code>
is a useful reference for <code>ggplot2</code> syntax.</p>
</div>
<div class="section level2">
<h2 id="fitting-an-spde-model-with-inlabru">Fitting an SPDE model with inlabru<a class="anchor" aria-label="anchor" href="#fitting-an-spde-model-with-inlabru"></a>
</h2>
<p>Make mesh. To avoid boundary effects in the region of interest, let
the mesh extend outside the data range.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">65</span>, by <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="co"># this sets mesh points - try others if you like</span></span>
<span><span class="op">(</span><span class="va">mesh1D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_mesh_1d.html" class="external-link">fm_mesh_1d</a></span><span class="op">(</span><span class="va">x</span>, degree <span class="op">=</span> <span class="fl">2</span>, boundary <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; fm_mesh_1d object:</span></span>
<span><span class="co">#&gt;   Manifold:  R1</span></span>
<span><span class="co">#&gt;   #{knots}:  151</span></span>
<span><span class="co">#&gt;   Interval:  (-10,  65)</span></span>
<span><span class="co">#&gt;   Boundary:  (free, free)</span></span>
<span><span class="co">#&gt;   B-spline degree:   2</span></span>
<span><span class="co">#&gt;   Basis d.o.f.:  152</span></span></code></pre></div>
<div class="section level3">
<h3 id="using-function-bru-to-fit-to-aggregated-count-data">Using function <code>bru( )</code> to fit to aggregated count
data<a class="anchor" aria-label="anchor" href="#using-function-bru-to-fit-to-aggregated-count-data"></a>
</h3>
<p>We need to specify model components and a model formula in order to
fit it. This can be done inside the call to <code><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru( )</a></code> but that
is a bit messy, so we’ll store it in <code>comp</code> first and then
pass that to <code><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru( )</a></code>.</p>
<p>Our response variable in the data frame <code>cd</code> is called
<code>count</code> so the model specification needs to have that on the
left of the <code>~</code>. We add an intercept component with
<code>+ Intercept(1)</code> on the right hand side (all the models we
use have intercepts), and because we want to fit a Gaussian random field
(GRF), it must have a GRF specification. In <code>inlabru</code> the GRF
specification is a function, which allows the GRF to be calculated at
any point in space while <code>inlabru</code> is doing its
calculations.</p>
<p>The user gets to name the GRF function. The syntax is
<code>myname(input, model= ...)</code>, where:</p>
<ul>
<li>‘myname’ is whatever you want to call the GRF (we called it
<code>field</code> below);</li>
<li>
<code>input</code> specifies the coordinates in which the GRF or
SPDE ‘lives’. Here we are working in one dimension, and we called that
dimension <code>x</code> when we set up the data set.</li>
<li>
<code>model=</code> designates the type of effect, here an SPDE
model object from the <code>INLA</code> function
<code><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.pcmatern.html" class="external-link">inla.spde2.pcmatern( )</a></code>, which requires a mesh to be passed
to it, so we pass it the 1D mesh that we created above,
<code>mesh1D</code>.</li>
</ul>
<p>For models that only sums all the model components, we don’t need to
specify the full predictor formula. Instead, we can provide the name of
the output to the left of the <code>~</code> in the component
specification, and “.” on the right hand side, which will cause it to
add all components (unless a subset is selected via the
<code>used</code> argument to <code><a href="https://inlabru-org.github.io/inlabru/reference/bru_obs.html" class="external-link">bru_obs()</a></code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">the_spde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.pcmatern.html" class="external-link">inla.spde2.pcmatern</a></span><span class="op">(</span><span class="va">mesh1D</span>,</span>
<span>  prior.range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.01</span><span class="op">)</span>,</span>
<span>  prior.sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">comp</span> <span class="op">&lt;-</span> <span class="op">~</span> <span class="fu">field</span><span class="op">(</span><span class="va">x</span>, model <span class="op">=</span> <span class="va">the_spde</span><span class="op">)</span> <span class="op">+</span> <span class="fu">Intercept</span><span class="op">(</span><span class="fl">1</span>, prec.linear <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Approximate model pretending that the counts are measured at
individual points:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2.bru</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru</a></span><span class="op">(</span></span>
<span>  <span class="va">comp</span>,</span>
<span>  <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru_obs.html" class="external-link">bru_obs</a></span><span class="op">(</span></span>
<span>    <span class="va">count</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="va">cd</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>    E <span class="op">=</span> <span class="va">exposure</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit2.bru</span><span class="op">)</span></span>
<span><span class="co">#&gt; inlabru version: 2.12.0.9016</span></span>
<span><span class="co">#&gt; INLA version: 25.05.18-1</span></span>
<span><span class="co">#&gt; Components:</span></span>
<span><span class="co">#&gt; field: main = spde(x), group = exchangeable(1L), replicate = iid(1L), NULL</span></span>
<span><span class="co">#&gt; Intercept: main = linear(1), group = exchangeable(1L), replicate = iid(1L), NULL</span></span>
<span><span class="co">#&gt; Observation models:</span></span>
<span><span class="co">#&gt;   Family: 'poisson'</span></span>
<span><span class="co">#&gt;     Tag: ''</span></span>
<span><span class="co">#&gt;     Data class: 'data.frame'</span></span>
<span><span class="co">#&gt;     Response class: 'integer'</span></span>
<span><span class="co">#&gt;     Predictor: count ~ .</span></span>
<span><span class="co">#&gt;     Additive/Linear: TRUE/TRUE</span></span>
<span><span class="co">#&gt;     Used components: effects[field, Intercept], latent[]</span></span>
<span><span class="co">#&gt; Time used:</span></span>
<span><span class="co">#&gt;     Pre = 0.515, Running = 0.493, Post = 0.0935, Total = 1.1 </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;            mean    sd 0.025quant 0.5quant 0.975quant  mode kld</span></span>
<span><span class="co">#&gt; Intercept 0.626 0.479     -0.437    0.658       1.52 0.729   0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;   Name     Model</span></span>
<span><span class="co">#&gt;     field SPDE2 model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model hyperparameters:</span></span>
<span><span class="co">#&gt;                   mean     sd 0.025quant 0.5quant 0.975quant   mode</span></span>
<span><span class="co">#&gt; Range for field 35.074 19.904     10.922   30.470      86.45 23.073</span></span>
<span><span class="co">#&gt; Stdev for field  0.594  0.221      0.275    0.557       1.13  0.488</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deviance Information Criterion (DIC) ...............: 59.22</span></span>
<span><span class="co">#&gt; Deviance Information Criterion (DIC, saturated) ....: 13.58</span></span>
<span><span class="co">#&gt; Effective number of parameters .....................: 5.16</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Watanabe-Akaike information criterion (WAIC) ...: 57.43</span></span>
<span><span class="co">#&gt; Effective number of parameters .................: 2.63</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Marginal log-Likelihood:  -36.69 </span></span>
<span><span class="co">#&gt;  is computed </span></span>
<span><span class="co">#&gt; Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">#&gt; (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre></div>
<p>Model that takes into account that the expected counts are
integrals:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_integration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_int.html" class="external-link">fm_int</a></span><span class="op">(</span></span>
<span>  <span class="va">mesh1D</span>,</span>
<span>  samplers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">cd</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">exposure</span><span class="op">/</span><span class="fl">2</span>, <span class="va">x</span> <span class="op">+</span> <span class="va">exposure</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"inlabru"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="st">"2.12.0.9016"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># From 2.12.0.9016:</span></span>
<span>  <span class="va">fit2block.bru</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru</a></span><span class="op">(</span></span>
<span>    <span class="va">comp</span>,</span>
<span>    <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru_obs.html" class="external-link">bru_obs</a></span><span class="op">(</span></span>
<span>      <span class="va">count</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>      data <span class="op">=</span> <span class="va">data_integration</span>,</span>
<span>      response_data <span class="op">=</span> <span class="va">cd</span>,</span>
<span>      aggregate <span class="op">=</span> <span class="st">"logsumexp"</span>,</span>
<span>      family <span class="op">=</span> <span class="st">"poisson"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># Before 2.12.0.9016:</span></span>
<span>  <span class="va">fit2block.bru</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru</a></span><span class="op">(</span></span>
<span>    <span class="va">comp</span>,</span>
<span>    <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru_obs.html" class="external-link">bru_obs</a></span><span class="op">(</span></span>
<span>      <span class="va">count</span> <span class="op">~</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_block.html" class="external-link">fm_block_logsumexp_eval</a></span><span class="op">(</span></span>
<span>        block <span class="op">=</span> <span class="va">.block</span>,</span>
<span>        weights <span class="op">=</span> <span class="va">weight</span>,</span>
<span>        n_block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">cd</span><span class="op">)</span>,</span>
<span>        values <span class="op">=</span> <span class="va">Intercept</span> <span class="op">+</span> <span class="va">field</span></span>
<span>      <span class="op">)</span>,</span>
<span>      allow_combine <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      data <span class="op">=</span> <span class="va">data_integration</span>,</span>
<span>      response_data <span class="op">=</span> <span class="va">cd</span>,</span>
<span>      family <span class="op">=</span> <span class="st">"poisson"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit2block.bru</span><span class="op">)</span></span>
<span><span class="co">#&gt; inlabru version: 2.12.0.9016</span></span>
<span><span class="co">#&gt; INLA version: 25.05.18-1</span></span>
<span><span class="co">#&gt; Components:</span></span>
<span><span class="co">#&gt; field: main = spde(x), group = exchangeable(1L), replicate = iid(1L), NULL</span></span>
<span><span class="co">#&gt; Intercept: main = linear(1), group = exchangeable(1L), replicate = iid(1L), NULL</span></span>
<span><span class="co">#&gt; Observation models:</span></span>
<span><span class="co">#&gt;   Family: 'poisson'</span></span>
<span><span class="co">#&gt;     Tag: ''</span></span>
<span><span class="co">#&gt;     Data class: 'tbl_df', 'tbl', 'data.frame'</span></span>
<span><span class="co">#&gt;     Response class: 'integer'</span></span>
<span><span class="co">#&gt;     Predictor: count ~ .</span></span>
<span><span class="co">#&gt;     Additive/Linear: FALSE/FALSE</span></span>
<span><span class="co">#&gt;     Used components: effects[field, Intercept], latent[]</span></span>
<span><span class="co">#&gt; Time used:</span></span>
<span><span class="co">#&gt;     Pre = 0.358, Running = 0.48, Post = 0.0822, Total = 0.92 </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;            mean    sd 0.025quant 0.5quant 0.975quant  mode kld</span></span>
<span><span class="co">#&gt; Intercept 0.627 0.472     -0.419    0.659      1.508 0.729   0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;   Name     Model</span></span>
<span><span class="co">#&gt;     field SPDE2 model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model hyperparameters:</span></span>
<span><span class="co">#&gt;                   mean     sd 0.025quant 0.5quant 0.975quant   mode</span></span>
<span><span class="co">#&gt; Range for field 33.590 19.718      9.978   28.954      84.61 21.549</span></span>
<span><span class="co">#&gt; Stdev for field  0.595  0.218      0.279    0.559       1.12  0.492</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deviance Information Criterion (DIC) ...............: 59.01</span></span>
<span><span class="co">#&gt; Deviance Information Criterion (DIC, saturated) ....: 13.37</span></span>
<span><span class="co">#&gt; Effective number of parameters .....................: 5.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Watanabe-Akaike information criterion (WAIC) ...: 57.28</span></span>
<span><span class="co">#&gt; Effective number of parameters .................: 2.57</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Marginal log-Likelihood:  -36.58 </span></span>
<span><span class="co">#&gt;  is computed </span></span>
<span><span class="co">#&gt; Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">#&gt; (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre></div>
<p>Predict the <code>lambda</code> function (the data argument must be a
data frame, see <code><a href="https://inlabru-org.github.io/inlabru/reference/predict.bru.html" class="external-link">?predict.bru</a></code>):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x4pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">55</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pred2.bru</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit2.bru</span>,</span>
<span>  <span class="va">x4pred</span>,</span>
<span>  <span class="va">x</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">field</span> <span class="op">+</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>  n.samples <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pred2block.bru</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit2block.bru</span>,</span>
<span>  <span class="va">x4pred</span>,</span>
<span>  <span class="va">x</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">field</span> <span class="op">+</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>  n.samples <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Let’s do a plot to compare the fitted model to the true model. The
true <code>lambda</code> is given by the function
<code>lambda2_1D()</code>, and the expected counts of the true model are
stored in the variable <code>E_nc2</code> which comes with the dataset
<code>Poisson2_1D</code>. For ease of use in plotting with
<code>ggplot2</code> (which needs a data frame), we create a data frame
which we call <code>true.lambda</code>, containing <code>x</code>- and
<code>y</code> variables as shown below.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">true.lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x4pred</span><span class="op">$</span><span class="va">x</span>, lambda <span class="op">=</span> <span class="fu">lambda2_1D</span><span class="op">(</span><span class="va">x4pred</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>These <code>ggplot2</code> commands should generate the plot shown
below. It shows the true intensities as a blue line, the observed
intensities as black dots, and the fitted intensity function as a red
curve, with 95% credible intervals shown as a light bands about the
curves.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/gg.html" class="external-link">gg</a></span><span class="op">(</span><span class="va">pred2.bru</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/gg.html" class="external-link">gg</a></span><span class="op">(</span><span class="va">pred2block.bru</span>,mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"red"</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cd</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">count</span> <span class="op">/</span> <span class="va">exposure</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">true.lambda</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">lambda</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">55</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Intensity"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in ggplot2::geom_line(data = data, line.map, ...): Ignoring</span></span>
<span><span class="co">#&gt; unknown aesthetics: <span style="color: #00BB00;">fill</span></span></span></code></pre></div>
<p><img src="aggregated_counts_1d_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>We can see that for this toy problem, using the proper aggregated
count observation model doesn’t make a noticeable difference to the
fitted model. For more realistic settings, in particular those involving
high resolution covariates, the distinction becomes important, and the
the integration scheme to resolve small features.</p>
<p>The computational time is available from
<code><a href="https://inlabru-org.github.io/inlabru/reference/bru_timings.html" class="external-link">bru_timings()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru_timings.html" class="external-link">bru_timings</a></span><span class="op">(</span><span class="va">fit2.bru</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Task Iteration       Time     System    Elapsed</span></span>
<span><span class="co">#&gt; 1 Preprocess         0 0.414 secs 0.028 secs 0.429 secs</span></span>
<span><span class="co">#&gt; 2 Preprocess         1 0.111 secs 0.016 secs 0.118 secs</span></span>
<span><span class="co">#&gt; 3 Run inla()         1 0.994 secs 0.168 secs 1.134 secs</span></span>
<span><span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru_timings.html" class="external-link">bru_timings</a></span><span class="op">(</span><span class="va">fit2block.bru</span><span class="op">)</span></span>
<span><span class="co">#&gt;          Task Iteration       Time     System    Elapsed</span></span>
<span><span class="co">#&gt; 1  Preprocess         0 0.115 secs 0.029 secs 0.132 secs</span></span>
<span><span class="co">#&gt; 2  Preprocess         1 0.212 secs 0.000 secs 0.212 secs</span></span>
<span><span class="co">#&gt; 3  Run inla()         1 0.709 secs 0.076 secs 0.808 secs</span></span>
<span><span class="co">#&gt; 4 Line search         1 0.014 secs 0.000 secs 0.014 secs</span></span>
<span><span class="co">#&gt; 5  Preprocess         2 0.214 secs 0.000 secs 0.215 secs</span></span>
<span><span class="co">#&gt; 6  Run inla()         2 0.690 secs 0.052 secs 0.799 secs</span></span>
<span><span class="co">#&gt; 7 Line search         2 0.244 secs 0.000 secs 0.244 secs</span></span>
<span><span class="co">#&gt; 8  Preprocess         3 0.174 secs 0.000 secs 0.174 secs</span></span>
<span><span class="co">#&gt; 9  Run inla()         3 0.928 secs 0.058 secs 0.945 secs</span></span>
<span><span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru_timings_plot.html" class="external-link">bru_timings_plot</a></span><span class="op">(</span><span class="va">fit2block.bru</span><span class="op">)</span></span></code></pre></div>
<p><img src="aggregated_counts_1d_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>To check the iterative method convergence, use
<code><a href="https://inlabru-org.github.io/inlabru/reference/bru_convergence_plot.html" class="external-link">bru_convergence_plot()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru_convergence_plot.html" class="external-link">bru_convergence_plot</a></span><span class="op">(</span><span class="va">fit2block.bru</span><span class="op">)</span></span></code></pre></div>
<p><img src="aggregated_counts_1d_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Finn Lindgren.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
